# ============================================================================
# GitHub Actions Workflow Ð´Ð»Ñ Telegram News Bot
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ, Ð¿Ð°Ñ€ÑÐ¸Ñ‚ Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸ Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÑ‚ Ð² Telegram
# ============================================================================

name: ðŸ“° News Bot

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ)
  schedule:
    - cron: '0 * * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ Ð² :00 Ð¼Ð¸Ð½ÑƒÑ‚
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· UI
  workflow_dispatch:
    inputs:
      max_articles:
        description: 'ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ ÑÑ‚Ð°Ñ‚ÐµÐ¹ Ð·Ð° Ð·Ð°Ð¿ÑƒÑÐº'
        required: false
        default: '3'
      debug:
        description: 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ debug-Ð»Ð¾Ð³Ð¸'
        required: false
        default: 'false'

  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð² main (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'

# Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð‘Ð”)
permissions:
  contents: write

# ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ¸
concurrency:
  group: news-bot
  cancel-in-progress: false

jobs:
  run-bot:
    name: ðŸ¤– Run News Bot
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ========================================
      # 1. ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ ÐžÐšÐ Ð£Ð–Ð•ÐÐ˜Ð¯
      # ========================================
      
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # ÐÑƒÐ¶ÐµÐ½ Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð»Ñ push
          token: ${{ secrets.GITHUB_TOKEN }}
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ git
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ========================================
      # 2. Ð—ÐÐŸÐ£Ð¡Ðš Ð‘ÐžÐ¢Ð
      # ========================================
      
      - name: ðŸš€ Run News Bot
        env:
          # Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¸Ð· GitHub Secrets
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          
          # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          MAX_ARTICLES_PER_RUN: ${{ github.event.inputs.max_articles || '5' }}
          GEMINI_MODEL: 'gemini-1.5-flash'
          DATABASE_PATH: 'processed.db'
          
          # Debug Ñ€ÐµÐ¶Ð¸Ð¼
          PYTHONUNBUFFERED: '1'
          LOG_LEVEL: ${{ github.event.inputs.debug == 'true' && 'DEBUG' || 'INFO' }}
        run: |
          echo "ðŸ• Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“Š ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ ÑÑ‚Ð°Ñ‚ÐµÐ¹: $MAX_ARTICLES_PER_RUN"
          echo ""
          python main.py

      # ========================================
      # 3. Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ˜Ð• Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥
      # ========================================
      
      - name: ðŸ’¾ Commit database changes
        run: |
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð‘Ð”
          if [ -f "processed.db" ]; then
            git add processed.db
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑŒ
            if git diff --staged --quiet; then
              echo "ðŸ“­ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
            else
              # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
              ARTICLE_COUNT=$(sqlite3 processed.db "SELECT COUNT(*) FROM processed_articles" 2>/dev/null || echo "0")
              
              git commit -m "ðŸ—„ï¸ Update database: $ARTICLE_COUNT articles total [skip ci]"
              git push
              echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
            fi
          else
            echo "âš ï¸ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          fi

      # ========================================
      # 4. ÐžÐ¢Ð§Ð•Ð¢ Ðž Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð˜
      # ========================================
      
      - name: ðŸ“Š Generate summary
        if: always()
        run: |
          echo "## ðŸ“° News Bot Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• Ð’Ñ€ÐµÐ¼Ñ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "processed.db" ]; then
            TOTAL=$(sqlite3 processed.db "SELECT COUNT(*) FROM processed_articles" 2>/dev/null || echo "N/A")
            LAST_24H=$(sqlite3 processed.db "SELECT COUNT(*) FROM processed_articles WHERE processed_at > datetime('now', '-1 day')" 2>/dev/null || echo "N/A")
            echo "| ðŸ—„ï¸ Ð’ÑÐµÐ³Ð¾ Ð² Ð‘Ð” | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“ˆ Ð—Ð° 24 Ñ‡Ð°ÑÐ° | $LAST_24H |" >> $GITHUB_STEP_SUMMARY
          fi
